[plantuml, chapter_03_class_diagram]
....
@startuml

package api {

  class Flask {
    allocate_endpoint()
  }
}

package sqlalchemy {
  class Session {
    query()
    add()
  }
}

package allocation {

  class services {
    allocate(line, repository, session)
  }

  class Batch {
    allocate ()
  }

  abstract class AbstractRepository {
    add ()
    get ()
    list ()
  }

  class BatchRepository {
    session: Session
  }

  class FakeRepository {
    batches: List<Batch>
  }
}

services -> AbstractRepository: uses

AbstractRepository <|-- FakeRepository : implements
AbstractRepository <|-- BatchRepository : implements
AbstractRepository --> Batch : stores
Flask --> services : invokes

BatchRepository --> Session : abstracts
@enduml
....


[ditaa, test_spectrum_diagram]
....
| Low feedback                                                  High feedback |
| Low barrier to change                                 High barrier to change|
| High system coverage                                       Focused coverage |
|                                                                             |
| <---------                                                     ---------->  |
| API tests                  service-layer tests                 domain tests |
....



[ditaa, service_layer_diagram_abstract_dependencies]
....
        +-----------------------------+
        |         Service Layer       |
        +-----------------------------+
           |                   |
           |                   | depends on abstraction
           V                   V
+------------------+     +--------------------+
|   Domain Model   |     | AbstractRepository |
+------------------+     +--------------------+
....

...


[ditaa, service_layer_diagram_test_dependencies]
....
        +-----------------------------+
        |           Tests             |-------------\
        +-----------------------------+             |
                       |                            |
                       V                            |
        +-----------------------------+             |
        |         Service Layer       |    provides |
        +-----------------------------+             |
           |                     |                  |
           V                     V                  |
+------------------+     +--------------------+     |
|   Domain Model   |     | AbstractRepository |     |
+------------------+     +--------------------+     |
                                    ^               |
                         implements |               |
                                    |               |
                         +----------------------+   |
                         |    FakeRepository    |<--/
                         |      (in-memory)     |
                         +----------------------+
....

...

[ditaa, service_layer_diagram_runtime_dependencies]
....
       +--------------------------------+
       | Flask API (Presentation layer) |-----------\
       +--------------------------------+           |
                       |                            |
                       V                            |
        +-----------------------------+             |
        |         Service Layer       |             |
        +-----------------------------+             |
           |                     |                  |
           V                     V                  |
+------------------+     +--------------------+     |
|   Domain Model   |     | AbstractRepository |     |
+------------------+     +--------------------+     |
              ^                     ^               |
              |                     |               |
              |          +----------------------+   |
      imports |          | SqlAlchemyRepository |<--/
              |          +----------------------+
              |                | uses
              |                V
           +-----------------------+
           |          ORM          |
           | (another abstraction) |
           +-----------------------+
                       |
                       | talks to
                       V
           +------------------------+
           |       Database         |
           +------------------------+
....
